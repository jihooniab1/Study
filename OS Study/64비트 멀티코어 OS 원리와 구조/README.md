# 64비트 멀티코어 OS 원리와 구조
책을 읽어보며 새로 알게된 사실이나 잘못 알고 있었던 점들을 정리해보고자 한다. Ubuntu 리눅스 환경에서 진행하였다. 

# Index

# 2장 (개발환경 구축)
GCC(GNU Compiler Collection)를 설치해야 합니다. 리눅스 환경은 gcc를 쉽게 설치할 수 있으나 

```
sudo apt install gcc-multilib
```
위 패키지를 설치하여 gcc가 32비트를 지원하도록 할 수 있습니다. NASM(The Network Assembler), QEMU 역시 그냥 설치해주면 됩니다.

# 3장 (64비트 프로세스)
인텔 64비트 호환 프로세서(이하 **x86-64 프로세서**)에는 크게 다섯 가지 운영 모드가 있습니다.

- 리얼 모드: 프로세서의 초기 상태로서 `16비트 모드`로 동작하며 8086 프로세서와 호환되는 모드입니다. 최대 **1MB($2^{20}$)** 주소 공간을 지원합니다.
- 보호 모드: `32비트 모드`로 동작하며, 세그먼트, 페이징 보호, 멀티태스킹 등의 기능을 제공합니다. **4GB($2^{32}$)** 주소 공간을 지원합니다.
- IA-32e 모드: 32비트 호환 모드와 64비트 모드의 두 가지 서브모드로 구성됩니다. **16EB($2^{64}$)** 주소 공간을 지원합니다.
- 시스템 관리 모드: 전원 관리나 하드웨어 제어 같은 득수 기능을 제공합니다.
- 가상 8086 모드: 보호 모드 내부에서 가상의 환경을 설정하여 리얼 모드처럼 동작하는 모드입니다.

위 모드 중 64비트 OS가 반드시 지원해야 하는 모드는 리얼 모드, 보호 모드, IA-32e 모드 중 64비트 서브 모드 총 세 가지가 있습니다. 

## 리얼 모드
프로세서가 어떤 상태나 모드에 있든, 전원이 켜지거나 리셋되면 프로세서는 리얼 모드로 진입합니다. 리얼 모드는 과거 16비트 프로세서와 동일하게 동작하며, BIOS의 여러 기능을 사용할 수 있습니다. 리얼 모드에서 하는 작업은 **OS 이미지를 디스크에서 메모리로 복사하여 보호 모드로 변경** 하는 것 밖에 없으나 대부분 작업을 어셈블리어로 처리합니다. 

## 보호 모드
보호 모드는 32비트 윈도우나 리눅스 OS가 동작하는 기본 모드로, IA-32e 모드로 전환하려면 반드시 거쳐야 하는 모드입니다. 최대 4G($2^{32}$) 주소 공간을 제공하며 멀티태스킹, 세그먼테이션, 페이징 등의 기능을 하드웨어적으로 지원합니다. 여러 기능을 지원하는만큼 레지스터와 자료구조 역시 다양합니다.

## IA-3e 모드
서브 모드로 32비트 호환 모드와 64비트 모드가 있습니다. 프로세서가 32비트 호환 모드일 때는 보호 모드에 있는 것처럼 동작하기에 32비트 코드를 그대로 실행할 수 있습니다.  <br>

![전환](./Images/ch3_1.png) <br>

위 그림은 각 운영 모드의 관계와 전환 조건을 나타내고 있습니다. 화살표가 연결되지 않은 모드끼리의 전환은 리셋이나 예외를 초래할 수 있습니다. 

아래 그림은 보호 모드와 IA-3e 모드에서의 레지스터를 나타내고 있습니다. <br>

![보호모드_레지스터](./Images/ch3_2.png) <br>
![IA3e레지스터](./Images/ch3_3.png) <br>

x86-64 프로세서에는 많은 레지스터가 있지만, OS 개발에 있어 큰 비중을 차지하는 레지스터는 **범용 레지스터, 세그먼트 레지스터, 컨트롤 레지스터** 세 가지입니다. 

범용 레지스터(General Purpose Register)는 계산, 메모리 어드레스 지정, 임시 저장 공간 등의 목적으로 사용합니다. 16비트와 32비트 모드를 지원하는 x86 계열(인텔 32비트 호환 프로세서)은 8개, 64비트 모드를 지원하는 x86-64 계열은 16개가 있습니다. x86-64 프로세서에는 x86 프로세서의 범용 레지스터 외에도 `R8 ~ R15`로 이름 붙여진 8개의 레지스터가 더 있는데, 차이점이 있다면 **특수한 용도가 정의되지 않았다** 는 것입니다. 다른 범용 레지스터들은 용도가 고정되지 않아 다양하게 사용될 수 있지만, 특정 명령어는 특정 레지스터와 같이 사용해야 합니다. 

|범용 레지스터 이름|용도|
|--------------|---|
|AX|산술 연산을 수행할 때 누산자로 사용|
|BX|데이터의 어드레스를 지정할 때 데이터 포인터로 사용|
|CX|루프 또는 문자열의 카운터|
|DX|I/O 어드레스를 지정할 때 사용되며, 산술 연산 수행할 때 보조 레지스터로 사용|
|SI|문자열에 관련된 작업을 할 때 원본 문자열의 인덱스로 활용|
|DI|문자열에 관련된 작업을 할 때 목적지 문자열의 인덱스로 활용|
|SP|스택의 포인터로 사용|
|BP|스택의 데이터에 접근할 때 데이터의 포인터로 사용|
|R8~R15| 다양한 용도로 사용|

